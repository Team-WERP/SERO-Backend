<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.werp.sero.notification.query.dao.NotificationMapper">

    <!-- 수신자별 알림 목록 조회 (최신순 50개) -->
    <select id="findByReceiverId" resultType="com.werp.sero.notification.query.dto.NotificationResponse">
        SELECT
            id,
            title,
            content,
            type,
            redirect_url as redirectUrl,
            CASE WHEN is_read = 1 THEN 1 ELSE 0 END as isRead,
            created_at as createdAt
        FROM notification
        WHERE receiver_id = #{receiverId}
        ORDER BY created_at DESC
        LIMIT 50
    </select>

    <!-- 읽지 않은 알림 개수 조회 -->
    <select id="countUnreadByReceiverId" resultType="int">
        SELECT COUNT(*)
        FROM notification
        WHERE receiver_id = #{receiverId}
        AND is_read = false
    </select>

    <!-- 알림 읽음 처리 -->
    <update id="markAsRead">
        UPDATE notification
        SET is_read = true
        WHERE id = #{notificationId}
    </update>

    <!-- 모든 알림 읽음 처리 -->
    <update id="markAllAsRead">
        UPDATE notification
        SET is_read = true
        WHERE receiver_id = #{receiverId}
        AND is_read = false
    </update>

    <!-- 알림 삭제 -->
    <delete id="deleteNotification">
        DELETE FROM notification
        WHERE id = #{notificationId}
    </delete>

    <!-- 고객사 직원용 알림 목록 조회 (최신순 50개) -->
    <select id="findByClientEmployeeId" resultType="com.werp.sero.notification.query.dto.NotificationResponse">
        SELECT
            id,
            title,
            content,
            type,
            redirect_url as redirectUrl,
            CASE WHEN is_read = 1 THEN 1 ELSE 0 END as isRead,
            created_at as createdAt
        FROM notification
        WHERE client_employee_id = #{clientEmployeeId}
        ORDER BY created_at DESC
        LIMIT 50
    </select>

    <!-- 고객사 직원용 읽지 않은 알림 개수 조회 -->
    <select id="countUnreadByClientEmployeeId" resultType="int">
        SELECT COUNT(*)
        FROM notification
        WHERE client_employee_id = #{clientEmployeeId}
        AND is_read = false
    </select>

    <!-- 고객사 직원용 모든 알림 읽음 처리 -->
    <update id="markAllAsReadForClient">
        UPDATE notification
        SET is_read = true
        WHERE client_employee_id = #{clientEmployeeId}
        AND is_read = false
    </update>

</mapper>
