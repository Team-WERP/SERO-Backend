<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.werp.sero.production.query.dao.WOQueryMapper">

    <!-- ===================================================== -->
    <!-- 작업일자 기준 작업지시 목록 조회 (1일)                   -->
    <!-- ===================================================== -->
    <select id="selectByDate"
            parameterType="string"
            resultType="com.werp.sero.production.query.dto.WOByDateResponseDTO">

        SELECT
            A.id          AS woId,
            A.wo_code     AS woCode,
            A.status      AS woStatus,
            A.work_date   AS workDate,

            B.id          AS lineId,
            B.line_name   AS lineName,

            D.name        AS materialName,
            D.spec        AS materialSpec,
            D.base_unit  AS baseUnit,

            A.quantity    AS plannedQuantity

        FROM work_order A
                 JOIN production_line B
                      ON A.line_id = B.id

                 JOIN line_material C
                      ON C.line_id = B.id

                 JOIN material D
                      ON C.material_id = D.id

        WHERE A.work_date = #{date}

        ORDER BY
            B.line_name ASC,
            A.wo_code ASC
    </select>

    <!-- ===================================================== -->
    <!--  일자 기준 작업지시 + 품목 Flat 조회 (Daily View)        -->
    <!-- ===================================================== -->
    <select id="selectDailyWorkOrders"
            parameterType="string"
            resultType="com.werp.sero.production.query.dto.WorkOrderDailyFlatDTO">

        SELECT
            /* Line */
            A.id               AS lineId,
            A.line_name        AS lineName,
            A.daily_capacity   AS dailyCapacity,

            /* WorkOrder */
            B.id               AS workOrderId,
            B.wo_code          AS workOrderCode,
            B.status           AS workOrderStatus,
            B.created_at       AS workOrderCreatedAt,
            B.quantity         AS workOrderQuantity,

            /* WorkOrderItem */
            C.id               AS workOrderItemId,
            C.planned_quantity AS plannedQuantity,

            /* ProductionPlan (nullable) */
            D.id               AS ppId,
            D.pp_code          AS ppCode,

            /* PR Item */
            E.id               AS prItemId,

            /* PR */
            G.id               AS prId,
            G.pr_code          AS prCode,

            /* Item */
            F.item_code        AS itemCode,
            F.item_name        AS itemName,
            F.unit             AS unit

        FROM production_line A
                 JOIN work_order B
                      ON B.line_id = A.id
                          AND B.work_date = #{date}

                 LEFT JOIN work_order_item C
                           ON C.work_order_id = B.id

                 LEFT JOIN production_plan D
                           ON C.pp_id = D.id
                 LEFT JOIN production_request_item E
                           ON C.pr_item_id = E.id
                 LEFT JOIN production_request G
                           ON E.pr_id = G.id
                 LEFT JOIN sales_order_item F
                           ON E.so_item_id = F.id

        ORDER BY
            A.id,
            B.created_at,
            C.id
    </select>

    <!-- ===================================================== -->
    <!--  라인 기준 긴급 생산 대상 PR Item 조회                 -->
    <!-- ===================================================== -->
    <select id="selectEmergencyTargetsByLine"
            parameterType="int"
            resultType="com.werp.sero.production.query.dto.WOEmergencyPRItemResponseDTO">

        SELECT
            E.id                     AS prItemId,
            F.id                     AS prId,
            F.pr_code                AS prCode,

            D.item_code              AS itemCode,
            D.item_name              AS itemName,
            D.unit                   AS unit,

            (E.quantity - E.produced_quantity) AS remainingQuantity,
            F.due_at                 AS dueAt

        FROM production_line A
                 JOIN line_material B
                      ON B.line_id = A.id

                 JOIN material C
                      ON C.id = B.material_id
                          AND C.type = 'MAT_FG'

                 JOIN sales_order_item D
                      ON D.item_code = C.material_code

                 JOIN production_request_item E
                      ON E.so_item_id = D.id

                 JOIN production_request F
                      ON F.id = E.pr_id

        WHERE A.id = #{lineId}
          AND E.status IN ('PIS_TARGET', 'PIS_PRODUCING')
          AND (E.quantity - E.produced_quantity) > 0

        ORDER BY
            F.due_at ASC,
            E.id ASC
    </select>

    <!-- ===================================================== -->
    <!--  작업지시 실적 목록 조회                                -->
    <!-- ===================================================== -->
    <select id="selectWorkOrderResultList"
            resultType="com.werp.sero.production.query.dto.WorkOrderResultListResponseDTO">

        SELECT
        A.id                 AS woId,
        A.wo_code            AS woCode,

        C.id                 AS lineId,
        C.line_name          AS lineName,

        I.item_name          AS itemName,

        A.quantity           AS plannedQuantity,
        B.good_quantity      AS producedQuantity,
        B.defective_quantity AS defectiveQuantity,

        B.start_time         AS startTime,
        B.end_time           AS endTime,
        B.work_time          AS workMinutes,

        D.name               AS workerName

        FROM work_order A
        JOIN work_order_result B
        ON B.wo_id = A.id
        JOIN production_line C
        ON C.id = A.line_id
        JOIN employee D
        ON D.id = A.manager_id
        JOIN (
        SELECT
        E.work_order_id,
        MIN(G.item_name) AS item_name
        FROM work_order_item E

        JOIN production_request_item F
        ON F.id = E.pr_item_id

        JOIN sales_order_item G
        ON G.id = F.so_item_id

        GROUP BY E.work_order_id
        ) I
        ON I.work_order_id = A.id

        WHERE 1 = 1

        <if test="startDate != null and endDate != null">
            AND A.work_date BETWEEN #{startDate} AND #{endDate}
        </if>

        <if test="lineId != null">
            AND C.id = #{lineId}
        </if>

        <if test="keyword != null and keyword != ''">
            AND (
            A.wo_code LIKE CONCAT('%', #{keyword}, '%')
            OR I.item_name LIKE CONCAT('%', #{keyword}, '%')
            )
        </if>

        ORDER BY
        B.end_time DESC
    </select>

    <!-- ===================================================== -->
    <!--  작업지시 기본 정보                                       -->
    <!-- ===================================================== -->
    <select id="selectWorkOrderBaseDetail"
            parameterType="int"
            resultType="com.werp.sero.production.query.dto.WorkOrderBaseDetailDTO">

        SELECT
            A.id                    AS woId,
            A.wo_code               AS woCode,
            A.status                AS status,

            B.id                    AS lineId,
            B.line_name             AS lineName,

            D.name                  AS managerName,

            A.quantity              AS plannedQuantity,
            C.good_quantity         AS goodQuantity,
            C.defective_quantity    AS defectiveQuantity,
            C.work_time             AS workTime,
            C.start_time            AS startTime,
            C.end_time              AS endTime

        FROM work_order A
                 JOIN production_line B
                      ON B.id = A.line_id

                 LEFT JOIN work_order_result C
                           ON C.wo_id = A.id

                 LEFT JOIN employee D
                           ON D.id = A.manager_id

        WHERE A.id = #{woId}

    </select>

    <!-- ===================================================== -->
    <!--  작업지시 품목 상세                                        -->
    <!-- ===================================================== -->
    <select id="selectWorkOrderItemDetails"
            parameterType="int"
            resultType="com.werp.sero.production.query.dto.WorkOrderItemDetailDTO">

        SELECT
            A.id                    AS woItemId,
            A.status                AS status,

            /* 연결된 생산요청 (PR) */
            C.id                    AS prId,
            C.pr_code               AS prCode,

            /* 연결된 생산계획 (PP, 선택) */
            F.id                    AS ppId,
            F.pp_code               AS ppCode,

            /* 주문 품목 정보 (Sales Order Item) */
            E.id                    AS soItemId,
            E.item_code             AS itemCode,
            E.item_name             AS itemName,
            E.unit                  AS unit,

            /* 수량 정보 */
            A.planned_quantity      AS plannedQuantity,
            A.produced_quantity     AS producedQuantity

            FROM work_order_item A
                 JOIN production_request_item B
                      ON B.id = A.pr_item_id
                 JOIN production_request C
                      ON C.id = B.pr_id
                 JOIN sales_order_item E
                      ON E.id = B.so_item_id
                 LEFT JOIN production_plan F
                           ON F.id = A.pp_id

        WHERE A.work_order_id = #{woId}

        ORDER BY A.id ASC
    </select>

    <!-- ===================================================== -->
    <!-- 작업지시 자재 상세                                         -->
    <!-- ===================================================== -->
    <select id="selectWorkOrderMaterialDetails"
            parameterType="int"
            resultType="com.werp.sero.production.query.dto.WorkOrderMaterialDetailDTO">

        SELECT
            B.id                 AS materialId,
            B.name               AS materialName,
            A.planned_quantity   AS plannedQuantity,
            A.actual_quantity    AS actualQuantity,
            A.status             AS status

        FROM work_order_material A
                 JOIN material B ON B.id = A.raw_material_id

        WHERE A.work_order_id = #{woId}
    </select>



</mapper>