<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.werp.sero.production.query.dao.ProductionDashboardMapper">

    <select id="selectTodayTargetQty" resultType="int">
        SELECT IFNULL(SUM(daily_capacity), 0)
        FROM production_line
        WHERE status = 'PL_ACTIVE'
    </select>

    <select id="selectTodayGoodQty" parameterType="string" resultType="int">
        SELECT IFNULL(SUM(wor.good_quantity), 0)
        FROM work_order wo
                 JOIN work_order_result wor ON wor.wo_id = wo.id
        WHERE wo.work_date = #{workDate}
    </select>

    <select id="selectTodayDefectAgg"
            parameterType="string"
            resultType="com.werp.sero.production.query.dto.dashboard.ProductionDashboardDefectAggDTO">
        SELECT
            IFNULL(SUM(wor.good_quantity), 0) AS goodQty,
            IFNULL(SUM(wor.defective_quantity), 0) AS defectiveQty
        FROM work_order wo
                 JOIN work_order_result wor ON wor.wo_id = wo.id
        WHERE wo.work_date = #{workDate}
    </select>

    <select id="selectTodayWorkOrderTotal" parameterType="string" resultType="int">
        SELECT COUNT(*)
        FROM work_order
        WHERE work_date = #{workDate}
    </select>

    <select id="selectTodayWorkOrderRunning" parameterType="string" resultType="int">
        SELECT COUNT(*)
        FROM work_order
        WHERE work_date = #{workDate}
          AND status = 'WO_RUN'
    </select>

    <!-- 상태별 작업지시 수 -->
    <select id="countWorkOrderByStatus" resultType="int">
        SELECT COUNT(DISTINCT wo.line_id)
        FROM work_order wo
        WHERE wo.work_date = #{workDate}
          AND wo.status = #{status}
    </select>

    <!-- 전체 생산 라인 수 -->
    <select id="selectTotalProductionLine" resultType="int">
        SELECT COUNT(*)
        FROM production_line
        WHERE status = 'PL_ACTIVE'
    </select>

    <select id="selectLineCapaRaw"
            parameterType="string"
            resultType="com.werp.sero.production.query.dto.dashboard.ProductionLineCapaListDTO">

        SELECT
        pl.id             AS lineId,
        pl.line_name      AS lineName,
        pl.daily_capacity AS dailyCapacity,

        IFNULL(SUM(
                           pp.production_quantity
                           / (
                                   DATEDIFF(
                                           STR_TO_DATE(pp.end_date, '%Y-%m-%d'),
                                           STR_TO_DATE(pp.start_date, '%Y-%m-%d')
                                       ) + 1
                               )
                   ), 0) AS plannedLoad

        FROM production_line pl
        LEFT JOIN production_plan pp
        ON pp.production_line_id = pl.id
        AND pp.status = 'PP_CONFIRMED'
        AND pp.start_date &lt;= #{today}
        AND pp.end_date   >= #{today}

        WHERE pl.status = 'PL_ACTIVE'
        GROUP BY pl.id, pl.line_name, pl.daily_capacity
        ORDER BY pl.line_name
    </select>

    <select id="selectMaterialShortage"
            resultType="com.werp.sero.production.query.dto.dashboard.MaterialShortageResponseDTO">

        SELECT
        m.id              AS materialId,
        m.material_code   AS materialCode,
        m.name            AS materialName,
        ws.current_stock  AS currentStock,
        ws.safety_stock   AS safetyStock,
        w.name            AS warehouseName
        FROM warehouse_stock ws
        JOIN material m
        ON m.id = ws.material_id
        JOIN warehouse w
        ON w.id = ws.warehouse_id
        WHERE ws.available_stock &lt; ws.safety_stock
        ORDER BY (ws.safety_stock - ws.available_stock) DESC
    </select>

    <select id="selectMonthlyProductionTrend"
            resultType="com.werp.sero.production.query.dto.dashboard.ProductionMonthlyTrendRawDTO">

        SELECT
            ym.month                               AS month,
        IFNULL(tp.target_quantity, 0)          AS targetQuantity,
        IFNULL(ap.actual_quantity, 0)          AS actualQuantity
        FROM
            (
            /* 최근 12개월 생성 */
            SELECT DATE_FORMAT(
            DATE_SUB(CURDATE(), INTERVAL n MONTH),
            '%Y-%m'
            ) AS month
            FROM (
            SELECT 0 n UNION ALL SELECT 1 UNION ALL SELECT 2 UNION ALL SELECT 3
            UNION ALL SELECT 4 UNION ALL SELECT 5 UNION ALL SELECT 6
            UNION ALL SELECT 7 UNION ALL SELECT 8 UNION ALL SELECT 9
            UNION ALL SELECT 10 UNION ALL SELECT 11
            ) t
            ) ym
            LEFT JOIN
            (
            /* 월별 목표 생산량 */
            SELECT
            DATE_FORMAT(
            STR_TO_DATE(pp.start_date, '%Y-%m-%d'),
            '%Y-%m'
            ) AS month,
            SUM(pp.production_quantity) AS target_quantity
            FROM production_plan pp
            WHERE pp.status = 'PP_CONFIRMED'
            GROUP BY month
            ) tp ON tp.month = ym.month
            LEFT JOIN
            (
            /* 월별 실제 생산량 */
            SELECT
            DATE_FORMAT(
            STR_TO_DATE(wr.start_time, '%Y-%m-%d'),
            '%Y-%m'
            ) AS month,
            SUM(wr.good_quantity) AS actual_quantity
            FROM work_order_result wr
            GROUP BY month
            ) ap ON ap.month = ym.month
        ORDER BY ym.month;
    </select>

</mapper>
