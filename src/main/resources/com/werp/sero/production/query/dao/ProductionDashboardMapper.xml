<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.werp.sero.production.query.dao.ProductionDashboardMapper">

    <select id="selectTodayTargetQty" resultType="int">
        SELECT IFNULL(SUM(daily_capacity), 0)
        FROM production_line
        WHERE status = 'PL_ACTIVE'
    </select>

    <select id="selectTodayGoodQty" parameterType="string" resultType="int">
        SELECT IFNULL(SUM(wor.good_quantity), 0)
        FROM work_order wo
                 JOIN work_order_result wor ON wor.wo_id = wo.id
        WHERE wo.work_date = #{workDate}
    </select>

    <select id="selectTodayDefectAgg"
            parameterType="string"
            resultType="com.werp.sero.production.query.dto.dashboard.ProductionDashboardDefectAggDTO">
        SELECT
            IFNULL(SUM(wor.good_quantity), 0) AS goodQty,
            IFNULL(SUM(wor.defective_quantity), 0) AS defectiveQty
        FROM work_order wo
                 JOIN work_order_result wor ON wor.wo_id = wo.id
        WHERE wo.work_date = #{workDate}
    </select>

    <select id="selectTodayWorkOrderTotal" parameterType="string" resultType="int">
        SELECT COUNT(*)
        FROM work_order
        WHERE work_date = #{workDate}
    </select>

    <select id="selectTodayWorkOrderRunning" parameterType="string" resultType="int">
        SELECT COUNT(*)
        FROM work_order
        WHERE work_date = #{workDate}
          AND status = 'WO_RUN'
    </select>

    <!-- 상태별 작업지시 수 -->
    <select id="countWorkOrderByStatus" resultType="int">
        SELECT COUNT(DISTINCT wo.line_id)
        FROM work_order wo
        WHERE wo.work_date = #{workDate}
          AND wo.status = #{status}
    </select>

    <!-- 전체 생산 라인 수 -->
    <select id="selectTotalProductionLine" resultType="int">
        SELECT COUNT(*)
        FROM production_line
        WHERE status = 'PL_ACTIVE'
    </select>

    <select id="selectLineCapaRaw"
            parameterType="string"
            resultType="com.werp.sero.production.query.dto.dashboard.ProductionLineCapaListDTO">

        SELECT
        pl.id             AS lineId,
        pl.line_name      AS lineName,
        pl.daily_capacity AS dailyCapacity,

        IFNULL(SUM(
                           pp.production_quantity
                           / (
                                   DATEDIFF(
                                           STR_TO_DATE(pp.end_date, '%Y-%m-%d'),
                                           STR_TO_DATE(pp.start_date, '%Y-%m-%d')
                                       ) + 1
                               )
                   ), 0) AS plannedLoad

        FROM production_line pl
        LEFT JOIN production_plan pp
        ON pp.production_line_id = pl.id
        AND pp.status = 'PP_CONFIRMED'
        AND pp.start_date &lt;= #{today}
        AND pp.end_date   >= #{today}

        WHERE pl.status = 'PL_ACTIVE'
        GROUP BY pl.id, pl.line_name, pl.daily_capacity
        ORDER BY pl.line_name
    </select>

    <select id="selectMaterialShortage"
            resultType="com.werp.sero.production.query.dto.dashboard.MaterialShortageResponseDTO">

        SELECT
        m.id              AS materialId,
        m.material_code   AS materialCode,
        m.name            AS materialName,
        ws.current_stock  AS currentStock,
        ws.safety_stock   AS safetyStock,
        w.name            AS warehouseName
        FROM warehouse_stock ws
        JOIN material m
        ON m.id = ws.material_id
        JOIN warehouse w
        ON w.id = ws.warehouse_id
        WHERE ws.available_stock &lt; ws.safety_stock
        ORDER BY (ws.safety_stock - ws.available_stock) DESC
    </select>
</mapper>
