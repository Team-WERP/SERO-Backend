<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.werp.sero.production.query.dao.PRQueryMapper">

    <!-- ===================================================== -->
    <!-- PR 임시저장 목록 조회 (작성자 기준)                     -->
    <!-- ===================================================== -->
    <select id="findDraftsByDrafter"
            resultType="com.werp.sero.production.query.dto.PRDraftListResponseDTO">

        SELECT
            A.id             AS prId,
            B.so_code        AS soCode,
            B.client_name    AS clientName,
            A.total_quantity AS totalQuantity,
            A.due_at         AS dueAt,
            A.created_at     AS createdAt,

            /* 대표 품목명 */
            (
            SELECT C.item_name
            FROM production_request_item D
            JOIN sales_order_item C ON D.so_item_id = C.id
            WHERE D.pr_id = A.id
            ORDER BY D.id ASC
            LIMIT 1
            ) AS representativeItemName,

            /* 품목 종류 수 */
            (
            SELECT COUNT(*)
            FROM production_request_item D
            WHERE D.pr_id = A.id
            ) AS itemTypeCount

        FROM production_request A
                 JOIN sales_order B ON A.so_id = B.id
        WHERE A.status = 'PR_TMP'
          AND A.drafter_id = #{drafterId}

        <if test="soId != null">
            AND A.so_id = #{soId}
        </if>

        <if test="soCode != null and soCode != ''">
            AND B.so_code LIKE CONCAT('%', #{soCode}, '%')
        </if>

        ORDER BY A.created_at DESC

    </select>

    <!-- ===================================================== -->
    <!-- PR 임시저장 상세 ResultMap                             -->
    <!-- ===================================================== -->
    <resultMap id="PRDraftDetailResultMap"
               type="com.werp.sero.production.query.dto.PRDraftDetailResponseDTO">

        <id property="prId" column="pr_id"/>

        <result property="soId" column="so_id"/>
        <result property="soCode" column="so_code"/>

        <result property="clientName" column="client_name"/>
        <result property="status" column="pr_status"/>
        <result property="dueAt" column="due_at"/>
        <result property="reason" column="reason"/>
        <result property="totalQuantity" column="pr_total_quantity"/>
        <result property="createdAt" column="created_at"/>

        <collection property="items"
                    ofType="com.werp.sero.production.query.dto.PRDraftItemResponseDTO">
            <id property="soItemId" column="so_item_id"/>

            <result property="itemCode" column="item_code"/>
            <result property="itemName" column="item_name"/>
            <result property="spec" column="spec"/>

            <result property="orderQuantity" column="order_quantity"/>
            <result property="unit" column="unit"/>

            <result property="unitPrice" column="unit_price"/>
            <result property="totalPrice" column="item_total_price"/>

            <result property="availableStock" column="available_stock"/>
            <result property="requiredQuantity" column="required_quantity"/>
            <result property="requestedQuantity" column="requested_quantity"/>
        </collection>
    </resultMap>

    <!-- ===================================================== -->
    <!-- PR 임시저장 상세 조회                                  -->
    <!-- ===================================================== -->
    <select id="findDraftDetail"
            resultMap="PRDraftDetailResultMap">

        SELECT
            A.id              AS pr_id,
            A.so_id           AS so_id,
            B.so_code         AS so_code,

            B.client_name     AS client_name,
            A.status          AS pr_status,
            A.due_at          AS due_at,
            A.reason          AS reason,
            A.total_quantity  AS pr_total_quantity,
            A.created_at      AS created_at,

            C.id              AS so_item_id,
            C.item_code       AS item_code,
            C.item_name       AS item_name,
            C.spec            AS spec,
            C.quantity        AS order_quantity,
            C.unit            AS unit,
            C.unit_price      AS unit_price,
            C.total_price     AS item_total_price,

            /* 가용 재고 */
            (
                SELECT IFNULL(SUM(E.available_stock), 0)
                FROM warehouse_stock E
                         JOIN material F ON E.material_id = F.id
                WHERE F.material_code = C.item_code
            ) AS available_stock,

            /* 생산 필요 수량 */
            GREATEST(
                        C.quantity -
                        (
                            SELECT IFNULL(SUM(E.available_stock), 0)
                            FROM warehouse_stock E
                                     JOIN material F ON E.material_id = F.id
                            WHERE F.material_code = C.item_code
                        ),
                        0
                ) AS required_quantity,

            /* 임시 저장된 생산요청 수량 */
            IFNULL(D.quantity, 0) AS requested_quantity

        FROM production_request A
                 JOIN sales_order B ON A.so_id = B.id
                 LEFT JOIN sales_order_item C ON B.id = C.so_id
                 LEFT JOIN production_request_item D
                           ON D.pr_id = A.id
                               AND D.so_item_id = C.id

        WHERE A.id = #{prId}
          AND A.status = 'PR_TMP'
          AND A.drafter_id = #{drafterId}

        ORDER BY C.id ASC
    </select>

    <!-- ===================================================== -->
    <!-- PR 목록 조회 (임시저장 제외)                            -->
    <!-- ===================================================== -->
    <select id="selectPRList"
            parameterType="com.werp.sero.production.query.dto.PRListSearchCondition"
            resultType="com.werp.sero.production.query.dto.PRListResponseDTO">

        SELECT
        A.id              AS prId,
        A.pr_code         AS prCode,
        B.so_code         AS soCode,

        /* 대표 품목명 */
        (
        SELECT C.item_name
        FROM production_request_item D
        JOIN sales_order_item C ON D.so_item_id = C.id
        WHERE D.pr_id = A.id
        ORDER BY D.id ASC
        LIMIT 1
        ) AS mainItemName,

        /* 품목 종류 수 */
        (
        SELECT COUNT(*)
        FROM production_request_item D
        WHERE D.pr_id = A.id
        ) AS itemTypeCount,

        A.total_quantity  AS totalQuantity,
        A.requested_at    AS requestedAt,
        A.due_at          AS dueAt,
        C.name            AS drafterName,
        D.name            AS managerName,
        A.status          AS status

        FROM production_request A
        JOIN sales_order B ON A.so_id = B.id
        JOIN employee C ON A.drafter_id = C.id
        LEFT JOIN employee D ON A.manager_id = D.id

        WHERE A.status != ('PR_TMP')

        <trim prefix="AND" prefixOverrides="AND |OR ">
            <if test="status != null and status != ''">
                A.status = #{status}
            </if>

            <if test="managerId != null">
                AND A.manager_id = #{managerId}
            </if>

            <if test="requestedDate != null and requestedDate != ''">
                AND DATE(A.requested_at) = #{requestedDate}
            </if>

            <if test="dueDate != null and dueDate != ''">
                AND DATE(A.due_at) = #{dueDate}
            </if>

            <if test="keyword != null and keyword != ''">
                AND (
                A.pr_code LIKE CONCAT('%', #{keyword}, '%')
                OR B.so_code LIKE CONCAT('%', #{keyword}, '%')
                OR D.name LIKE CONCAT('%', #{keyword}, '%')
                OR EXISTS (
                SELECT 1
                FROM production_request_item E
                JOIN sales_order_item F ON E.so_item_id = F.id
                WHERE E.pr_id = A.id
                AND F.item_name LIKE CONCAT('%', #{keyword}, '%')
                )
                )
            </if>
        </trim>

        ORDER BY A.created_at DESC
    </select>

    <!-- ===================================================== -->
    <!-- PR 확정 상세 ResultMap                                 -->
    <!-- ===================================================== -->
    <resultMap id="PRDetailResultMap"
               type="com.werp.sero.production.query.dto.PRDetailResponseDTO">

        <!-- 부모 식별자 필수 -->
        <id property="header.prId" column="pr_id"/>

        <association property="header"
                     javaType="com.werp.sero.production.query.dto.PRDetailResponseDTO$Header">
            <result property="prId" column="pr_id"/>
            <result property="soId" column="so_id"/>
            <result property="prCode" column="pr_code"/>
            <result property="soCode" column="so_code"/>
            <result property="status" column="pr_status"/>
            <result property="productionProgress" column="production_progress"/>
            <result property="requestedAt" column="requested_at"/>
            <result property="dueAt" column="due_at"/>
            <result property="drafterName" column="drafter_name"/>
            <result property="managerId" column="manager_id"/>
            <result property="managerName" column="manager_name"/>
            <result property="totalQuantity" column="total_quantity"/>
            <result property="approvalId" column="approval_id"/>
            <result property="approvalCode" column="approval_code"/>
            <result property="drafterDepartment" column="drafter_department"/>
            <result property="drafterPosition" column="drafter_position"/>
            <result property="drafterRank" column="drafter_rank"/>
        </association>

        <collection property="items"
                    ofType="com.werp.sero.production.query.dto.PRDetailResponseDTO$Item">
            <id property="prItemId" column="pr_item_id"/>
            <result property="soItemId" column="so_item_id"/>

            <result property="itemCode" column="item_code"/>
            <result property="itemName" column="item_name"/>
            <result property="spec" column="spec"/>
            <result property="unit" column="unit"/>

            <result property="requestedQuantity" column="requested_quantity"/>
            <result property="status" column="pr_item_status"/>
        </collection>

        <collection property="approvalLines"
                    ofType="com.werp.sero.production.query.dto.PRDetailResponseDTO$ApprovalLine"
                    notNullColumn="approval_line_id">
            <id property="sequence" column="approval_sequence"/>
            <result property="approverName" column="approver_name"/>
            <result property="approverDepartment" column="approver_department"/>
            <result property="approverPosition" column="approver_position"/>
            <result property="approverRank" column="approver_rank"/>
            <result property="status" column="approval_status"/>
            <result property="lineType" column="line_type"/>
            <result property="processedAt" column="approval_processed_at"/>
            <result property="note" column="approval_note"/>
        </collection>

    </resultMap>

    <!-- ===================================================== -->
    <!-- PR 확정 상세 조회                                      -->
    <!-- ===================================================== -->
    <select id="selectPRDetail"
            parameterType="int"
            resultMap="PRDetailResultMap">

        SELECT
        A.id             AS pr_id,
        A.so_id          AS so_id,
        A.pr_code        AS pr_code,
        B.so_code        AS so_code,
        A.status         AS pr_status,
        A.requested_at   AS requested_at,
        A.due_at         AS due_at,
        A.total_quantity AS total_quantity,

        A.manager_id     AS manager_id,
        C.name           AS drafter_name,
        D.name           AS manager_name,
        L.id             AS approval_id,
        A.approval_code  AS approval_code,
        P.dept_name      AS drafter_department,
        Q.name           AS drafter_position,
        R.name           AS drafter_rank,

        G.production_progress AS production_progress,

        E.id             AS pr_item_id,
        E.so_item_id     AS so_item_id,
        E.quantity       AS requested_quantity,
        E.status         AS pr_item_status,

        F.item_code      AS item_code,
        F.item_name      AS item_name,
        F.spec           AS spec,
        F.unit           AS unit,

        M.id             AS approval_line_id,
        M.sequence       AS approval_sequence,
        M.status         AS approval_status,
        M.line_type      AS line_type,
        M.processed_at   AS approval_processed_at,
        M.note           AS approval_note,

        N.name           AS approver_name,
        O.dept_name      AS approver_department,
        S.name           AS approver_position,
        T.name           AS approver_rank

        FROM production_request A
        JOIN sales_order B ON A.so_id = B.id
        JOIN employee C ON A.drafter_id = C.id
        LEFT JOIN employee D ON A.manager_id = D.id

        JOIN production_request_item E ON E.pr_id = A.id
        JOIN sales_order_item F ON F.id = E.so_item_id

        LEFT JOIN (
        SELECT pr_id,
        CASE
        WHEN SUM(status = 'PIS_PRODUCING') > 0 THEN 'PRODUCING'
        WHEN SUM(status = 'PIS_PLANNED')   > 0 THEN 'PLANNED'
        WHEN SUM(status = 'PIS_TARGET')    > 0 THEN 'PLANNING'
        WHEN COUNT(*) = SUM(status = 'PIS_DONE') THEN 'COMPLETED'
        ELSE 'NOT_STARTED'
        END AS production_progress
        FROM production_request_item
        GROUP BY pr_id
        ) G ON G.pr_id = A.id

        LEFT JOIN approval L ON A.approval_code = L.approval_code
        LEFT JOIN approval_line M
        ON L.id = M.approval_id
        AND (M.line_type = 'AT_APPR' OR M.line_type = 'AT_RVW')
        LEFT JOIN employee N ON M.approver_id = N.id
        LEFT JOIN department O ON N.dept_id = O.id
        LEFT JOIN common_code S ON N.position_code = S.code
        LEFT JOIN common_code T ON N.rank_code = T.code

        LEFT JOIN department P ON C.dept_id = P.id
        LEFT JOIN common_code Q ON C.position_code = Q.code
        LEFT JOIN common_code R ON C.rank_code = R.code

        WHERE A.id = #{prId}
        AND A.status NOT IN ('PR_TMP')
        ORDER BY E.id, M.sequence
    </select>

    <!-- ===================================================== -->
    <!-- PR 기본 정보 조회                                      -->
    <!-- ===================================================== -->
    <resultMap id="PRBasicInfoResultMap"
               type="com.werp.sero.production.query.dto.PRBasicInfoDTO">
        <id property="prId" column="prId"/>
        <result property="prCode" column="prCode"/>
        <result property="status" column="status"/>
    </resultMap>

    <select id="selectPRBasicInfo"
            parameterType="int"
            resultMap="PRBasicInfoResultMap">

        SELECT
            A.id        AS prId,
            A.pr_code   AS prCode,
            A.status    AS status
        FROM production_request A
        WHERE A.id = #{prId}

    </select>

    <!-- ===================================================== -->
    <!-- PR 기준 계획 대상 Item 목록 조회                            -->
    <!-- ===================================================== -->
    <resultMap id="PRPlanItemResultMap"
               type="com.werp.sero.production.query.dto.PRPlanItemResponseDTO">
        <id property="prItemId" column="prItemId"/>
        <result property="soItemId" column="soItemId"/>

        <result property="itemCode" column="itemCode"/>
        <result property="itemName" column="itemName"/>

        <result property="requestedQuantity" column="requestedQuantity"/>
        <result property="plannedQuantity" column="plannedQuantity"/>
        <result property="remainingQuantity" column="remainingQuantity"/>

        <result property="status" column="status"/>
    </resultMap>

    <select id="selectPRPlanItems"
            parameterType="int"
            resultMap="PRPlanItemResultMap">

        SELECT
            B.id             AS prItemId,
            B.so_item_id     AS soItemId,

            C.item_code      AS itemCode,
            C.item_name      AS itemName,

            B.quantity       AS requestedQuantity,

            IFNULL(SUM(D.production_quantity), 0) AS plannedQuantity,
            B.quantity - IFNULL(SUM(D.production_quantity), 0) AS remainingQuantity,

            B.status         AS status
        FROM production_request_item B
                 JOIN sales_order_item C
                      ON B.so_item_id = C.id
                 LEFT JOIN production_plan D
                           ON D.pr_item_quantity_id = B.id
        WHERE B.pr_id = #{prId}
        GROUP BY
            B.id,
            B.so_item_id,
            C.item_code,
            C.item_name,
            B.quantity,
            B.status
        ORDER BY B.id

    </select>

    <!-- ===================================================== -->
    <!-- 주문 id에 대한 모든 상태의 PR 목록 조회                       -->
    <!-- ===================================================== -->
    <select id="selectPRListByOrderId"
            resultType="com.werp.sero.production.query.dto.PRListResponseDTO">
        SELECT
            A.id              AS prId,
            A.pr_code         AS prCode,
            B.so_code         AS soCode,

            /* 대표 품목명 조회 */
            (
                SELECT C.item_name
                FROM production_request_item D
                         JOIN sales_order_item C ON D.so_item_id = C.id
                WHERE D.pr_id = A.id
                ORDER BY D.id ASC
                                 LIMIT 1
            ) AS mainItemName,

        /* 품목 종류 수 계산 */
        (
            SELECT COUNT(*)
            FROM production_request_item D
            WHERE D.pr_id = A.id
        ) AS itemTypeCount,

        A.total_quantity  AS totalQuantity,
        DATE_FORMAT(A.requested_at, '%Y-%m-%d') AS requestedAt,
        DATE_FORMAT(A.due_at, '%Y-%m-%d')              AS dueAt,

        C.name            AS drafterName,
        D.name            AS managerName,
        A.status          AS status,
        A.pr_url          AS prUrl

        FROM production_request A
            JOIN sales_order B ON A.so_id = B.id
            JOIN employee C ON A.drafter_id = C.id
            LEFT JOIN employee D ON A.manager_id = D.id

        WHERE A.so_id = #{orderId}

        ORDER BY A.created_at DESC
    </select>


</mapper>
