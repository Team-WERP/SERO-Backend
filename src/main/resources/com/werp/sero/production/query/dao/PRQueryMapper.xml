<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.werp.sero.production.query.dao.PRQueryMapper">

    <select id="findDraftsByDrafter"
            resultType="com.werp.sero.production.query.dto.PRDraftListResponseDTO">

        SELECT
            A.id             AS prId,
            B.so_code        AS soCode,
            B.client_name    AS clientName,
            A.total_quantity AS totalQuantity,
            A.due_at         AS dueAt,
            A.created_at     AS createdAt,

            /* 대표 품목명 */
            (
            SELECT C.item_name
            FROM production_request_item D
            JOIN sales_order_item C ON D.so_item_id = C.id
            WHERE D.pr_id = A.id
            ORDER BY D.id ASC
            LIMIT 1
            ) AS representativeItemName,

            /* 품목 종류 수 */
            (
            SELECT COUNT(*)
            FROM production_request_item D
            WHERE D.pr_id = A.id
            ) AS itemTypeCount

        FROM production_request A
                 JOIN sales_order B ON A.so_id = B.id
        WHERE A.status = 'PR_TMP'
          AND A.drafter_id = #{drafterId}

        <if test="soId != null">
            AND A.so_id = #{soId}
        </if>

        ORDER BY A.created_at DESC

    </select>

</mapper>
