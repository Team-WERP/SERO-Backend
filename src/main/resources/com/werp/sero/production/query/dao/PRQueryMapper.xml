<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.werp.sero.production.query.dao.PRQueryMapper">

    <!-- ===================================================== -->
    <!-- PR 임시저장 목록 조회 (작성자 기준)                     -->
    <!-- ===================================================== -->
    <select id="findDraftsByDrafter"
            resultType="com.werp.sero.production.query.dto.PRDraftListResponseDTO">

        SELECT
            A.id             AS prId,
            B.so_code        AS soCode,
            B.client_name    AS clientName,
            A.total_quantity AS totalQuantity,
            A.due_at         AS dueAt,
            A.created_at     AS createdAt,

            /* 대표 품목명 */
            (
            SELECT C.item_name
            FROM production_request_item D
            JOIN sales_order_item C ON D.so_item_id = C.id
            WHERE D.pr_id = A.id
            ORDER BY D.id ASC
            LIMIT 1
            ) AS representativeItemName,

            /* 품목 종류 수 */
            (
            SELECT COUNT(*)
            FROM production_request_item D
            WHERE D.pr_id = A.id
            ) AS itemTypeCount

        FROM production_request A
                 JOIN sales_order B ON A.so_id = B.id
        WHERE A.status = 'PR_TMP'
          AND A.drafter_id = #{drafterId}

        <if test="soId != null">
            AND A.so_id = #{soId}
        </if>

        <if test="soCode != null and soCode != ''">
            AND B.so_code LIKE CONCAT('%', #{soCode}, '%')
        </if>

        ORDER BY A.created_at DESC

    </select>

    <!-- ===================================================== -->
    <!-- PR 임시저장 상세 ResultMap                             -->
    <!-- ===================================================== -->
    <resultMap id="PRDraftDetailResultMap"
               type="com.werp.sero.production.query.dto.PRDraftDetailResponseDTO">

        <id property="prId" column="pr_id"/>

        <result property="soId" column="so_id"/>
        <result property="soCode" column="so_code"/>

        <result property="status" column="pr_status"/>
        <result property="dueAt" column="due_at"/>
        <result property="reason" column="reason"/>
        <result property="totalQuantity" column="pr_total_quantity"/>
        <result property="createdAt" column="created_at"/>

        <collection property="items"
                    ofType="com.werp.sero.production.query.dto.PRDraftItemResponseDTO">
            <id property="soItemId" column="so_item_id"/>

            <result property="itemCode" column="item_code"/>
            <result property="itemName" column="item_name"/>
            <result property="spec" column="spec"/>

            <result property="orderQuantity" column="order_quantity"/>
            <result property="unit" column="unit"/>

            <result property="unitPrice" column="unit_price"/>
            <result property="totalPrice" column="item_total_price"/>

            <result property="availableStock" column="available_stock"/>
            <result property="requiredQuantity" column="required_quantity"/>
            <result property="requestedQuantity" column="requested_quantity"/>
        </collection>
    </resultMap>

    <!-- ===================================================== -->
    <!-- PR 임시저장 상세 조회                                  -->
    <!-- ===================================================== -->
    <select id="findDraftDetail"
            resultMap="PRDraftDetailResultMap">

        SELECT
            A.id              AS pr_id,
            A.so_id           AS so_id,
            B.so_code         AS so_code,

            A.status          AS pr_status,
            A.due_at          AS due_at,
            A.reason          AS reason,
            A.total_quantity  AS pr_total_quantity,
            A.created_at      AS created_at,

            C.id              AS so_item_id,
            C.item_code       AS item_code,
            C.item_name       AS item_name,
            C.spec            AS spec,
            C.quantity        AS order_quantity,
            C.unit            AS unit,
            C.unit_price      AS unit_price,
            C.total_price     AS item_total_price,

            /* 가용 재고 */
            (
                SELECT IFNULL(SUM(E.available_stock), 0)
                FROM warehouse_stock E
                         JOIN material F ON E.material_id = F.id
                WHERE F.material_code = C.item_code
            ) AS available_stock,

            /* 생산 필요 수량 */
            GREATEST(
                        C.quantity -
                        (
                            SELECT IFNULL(SUM(E.available_stock), 0)
                            FROM warehouse_stock E
                                     JOIN material F ON E.material_id = F.id
                            WHERE F.material_code = C.item_code
                        ),
                        0
                ) AS required_quantity,

            /* 임시 저장된 생산요청 수량 */
            IFNULL(D.quantity, 0) AS requested_quantity

        FROM production_request A
                 JOIN sales_order B ON A.so_id = B.id
                 LEFT JOIN sales_order_item C ON B.id = C.so_id
                 LEFT JOIN production_request_item D
                           ON D.pr_id = A.id
                               AND D.so_item_id = C.id

        WHERE A.id = #{prId}
          AND A.status = 'PR_TMP'
          AND A.drafter_id = #{drafterId}

        ORDER BY C.id ASC
    </select>

    <!-- ===================================================== -->
    <!-- PR 목록 조회 (임시저장 제외)                            -->
    <!-- ===================================================== -->
    <select id="selectPRList"
            parameterType="com.werp.sero.production.query.dto.PRListSearchCondition"
            resultType="com.werp.sero.production.query.dto.PRListResponseDTO">

        SELECT
        A.id              AS prId,
        A.pr_code         AS prCode,
        B.so_code         AS soCode,

        /* 대표 품목명 */
        (
        SELECT C.item_name
        FROM production_request_item D
        JOIN sales_order_item C ON D.so_item_id = C.id
        WHERE D.pr_id = A.id
        ORDER BY D.id ASC
        LIMIT 1
        ) AS mainItemName,

        /* 품목 종류 수 */
        (
        SELECT COUNT(*)
        FROM production_request_item D
        WHERE D.pr_id = A.id
        ) AS itemTypeCount,

        A.total_quantity  AS totalQuantity,
        A.requested_at    AS requestedAt,
        A.due_at          AS dueAt,
        C.name            AS drafterName,
        D.name            AS managerName,
        A.status          AS status

        FROM production_request A
        JOIN sales_order B ON A.so_id = B.id
        JOIN employee C ON A.drafter_id = C.id
        LEFT JOIN employee D ON A.manager_id = D.id

        WHERE A.status NOT IN ('PR_TMP')

        <trim prefix="AND" prefixOverrides="AND |OR ">
            <if test="status != null and status != ''">
                A.status = #{status}
            </if>

            <if test="managerId != null">
                AND A.manager_id = #{managerId}
            </if>

            <if test="requestedDate != null and requestedDate != ''">
                AND DATE(A.requested_at) = #{requestedDate}
            </if>

            <if test="dueDate != null and dueDate != ''">
                AND DATE(A.due_at) = #{dueDate}
            </if>

            <if test="keyword != null and keyword != ''">
                AND (
                A.pr_code LIKE CONCAT('%', #{keyword}, '%')
                OR B.so_code LIKE CONCAT('%', #{keyword}, '%')
                OR EXISTS (
                SELECT 1
                FROM production_request_item PRI
                JOIN sales_order_item SOI ON PRI.so_item_id = SOI.id
                WHERE PRI.pr_id = A.id
                AND SOI.item_name LIKE CONCAT('%', #{keyword}, '%')
                )
                )
            </if>
        </trim>

        ORDER BY A.created_at DESC
    </select>

    <!-- ===================================================== -->
    <!-- PR 확정 상세 ResultMap                                 -->
    <!-- ===================================================== -->
    <resultMap id="PRDetailResultMap"
               type="com.werp.sero.production.query.dto.PRDetailResponseDTO">

        <!-- 부모 식별자 필수 -->
        <id property="header.prId" column="pr_id"/>

        <association property="header"
                     javaType="com.werp.sero.production.query.dto.PRDetailResponseDTO$Header">
            <result property="prId" column="pr_id"/>
            <result property="prCode" column="pr_code"/>
            <result property="soCode" column="so_code"/>
            <result property="status" column="pr_status"/>
            <result property="requestedAt" column="requested_at"/>
            <result property="dueAt" column="due_at"/>
            <result property="drafterName" column="drafter_name"/>
            <result property="managerName" column="manager_name"/>
            <result property="totalQuantity" column="total_quantity"/>
        </association>

        <collection property="items"
                    ofType="com.werp.sero.production.query.dto.PRDetailResponseDTO$Item">
            <id property="prItemId" column="pr_item_id"/>
            <result property="soItemId" column="so_item_id"/>

            <result property="itemCode" column="item_code"/>
            <result property="itemName" column="item_name"/>
            <result property="spec" column="spec"/>

            <result property="requestedQuantity" column="requested_quantity"/>
            <result property="status" column="pr_item_status"/>
        </collection>

    </resultMap>

    <!-- ===================================================== -->
    <!-- PR 확정 상세 조회                                      -->
    <!-- ===================================================== -->
    <select id="selectPRDetail"
            parameterType="int"
            resultMap="PRDetailResultMap">

        SELECT
        A.id             AS pr_id,
        A.pr_code        AS pr_code,
        B.so_code        AS so_code,
        A.status         AS pr_status,
        A.requested_at   AS requested_at,
        A.due_at         AS due_at,
        A.total_quantity AS total_quantity,

        C.name           AS drafter_name,
        D.name           AS manager_name,

        E.id             AS pr_item_id,
        E.so_item_id     AS so_item_id,
        E.quantity       AS requested_quantity,
        E.status         AS pr_item_status,

        F.item_code      AS item_code,
        F.item_name      AS item_name,
        F.spec           AS spec

        FROM production_request A
        JOIN sales_order B
        ON A.so_id = B.id
        JOIN employee C
        ON A.drafter_id = C.id
        LEFT JOIN employee D
        ON A.manager_id = D.id

        JOIN production_request_item E
        ON E.pr_id = A.id
        JOIN sales_order_item F
        ON F.id = E.so_item_id

        WHERE A.id = #{prId}
        AND A.status NOT IN ('PR_TMP')

        ORDER BY E.id ASC
    </select>

</mapper>
