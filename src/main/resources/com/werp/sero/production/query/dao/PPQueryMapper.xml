<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.werp.sero.production.query.dao.PPQueryMapper">

    <!-- ===================================================== -->
    <!-- PR Item 기본 정보 조회                                    -->
    <!-- ===================================================== -->

    <select id="selectPRItemPlanningBase"
            parameterType="int"
            resultType="com.werp.sero.production.query.dto.PRItemPlanningBaseDTO">

        SELECT
            A.id            AS prItemId,
            B.item_code     AS itemCode,
            B.item_name     AS itemName,
            A.quantity      AS requestedQuantity
        FROM production_request_item A
                 JOIN sales_order_item B
                      ON A.so_item_id = B.id
        WHERE A.id = #{prItemId}

    </select>

    <!-- ===================================================== -->
    <!-- 기존 생산계획 목록 조회                                     -->
    <!-- ===================================================== -->
    <select id="selectProductionPlansByPRItem"
            parameterType="int"
            resultType="com.werp.sero.production.query.dto.ProductionPlanSummaryDTO">

        SELECT
            A.id                  AS ppId,
            A.production_line_id  AS lineId,
            B.line_name           AS lineName,
            A.start_date          AS startDate,
            A.end_date            AS endDate,
            A.production_quantity AS productionQuantity
        FROM production_plan A
                 JOIN production_line B
                      ON A.production_line_id = B.id
        WHERE A.pr_item_quantity_id = #{prItemId}
        ORDER BY A.start_date

    </select>

    <!-- ===================================================== -->
    <!-- 가동 가능한 생산라인 목록 조회                                -->
    <!-- ===================================================== -->
    <select id="selectProductionLines"
            parameterType="map"
            resultType="com.werp.sero.production.query.dto.ProductionLineResponseDTO">

        SELECT
        A.id        AS lineId,
        A.line_name AS lineName,
        A.status    AS status
        FROM production_line A
        WHERE A.status = 'PL_ACTIVE'
        <if test="factoryId != null">
            AND A.factory_id = #{factoryId}
        </if>
        ORDER BY A.id

    </select>


</mapper>