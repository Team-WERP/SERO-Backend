<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.werp.sero.production.query.dao.PPQueryMapper">

    <!-- ===================================================== -->
    <!-- PR Item 기본 정보 조회                                    -->
    <!-- ===================================================== -->

    <select id="selectPRItemPlanningBase"
            parameterType="int"
            resultType="com.werp.sero.production.query.dto.PRItemPlanningBaseDTO">

        SELECT
            A.id            AS prItemId,
            B.item_code     AS itemCode,
            B.item_name     AS itemName,
            A.quantity      AS requestedQuantity
        FROM production_request_item A
                 JOIN sales_order_item B
                      ON A.so_item_id = B.id
        WHERE A.id = #{prItemId}

    </select>

    <!-- ===================================================== -->
    <!-- 기존 생산계획 목록 조회                                     -->
    <!-- ===================================================== -->
    <select id="selectProductionPlansByPRItem"
            parameterType="int"
            resultType="com.werp.sero.production.query.dto.ProductionPlanSummaryDTO">

        SELECT
            A.id                  AS ppId,
            A.production_line_id  AS lineId,
            B.line_name           AS lineName,
            A.start_date          AS startDate,
            A.end_date            AS endDate,
            A.production_quantity AS productionQuantity
        FROM production_plan A
                 JOIN production_line B
                      ON A.production_line_id = B.id
        WHERE A.pr_item_id = #{prItemId}
        ORDER BY A.start_date

    </select>

    <!-- ===================================================== -->
    <!-- 가동 가능한 생산라인 목록 조회                                -->
    <!-- ===================================================== -->
    <select id="selectProductionLines"
            parameterType="map"
            resultType="com.werp.sero.production.query.dto.ProductionLineResponseDTO">

        SELECT
        A.id            AS lineId,
        A.line_name     AS lineName,
        A.status        AS status,
        A.daily_capacity AS dailyCapacity,

        C.id             AS materialId,
        C.material_code  AS materialCode,
        C.name           AS materialName,
        C.base_unit      AS unit

        FROM production_line A
        JOIN line_material B
          ON B.line_id = A.id
        JOIN material C
          ON C.id = B.material_id
        AND C.type = 'MAT_FG'

        WHERE A.status = 'PL_ACTIVE'
        <if test="factoryId != null">
            AND A.factory_id = #{factoryId}
        </if>
        ORDER BY A.id

    </select>

    <!-- ===================================================== -->
    <!-- 미편성 생산요청 목록 조회                                     -->
    <!-- ===================================================== -->
    <select id="selectUnassignedTargets"
            resultType="com.werp.sero.production.query.dto.PPUnassignedResponseDTO">

        SELECT
            A.id                AS prItemId,
            A.pr_id             AS prId,
            A.quantity          AS requestedQuantity,
            A.status            AS prItemStatus,

            B.pr_code           AS prCode,
            B.requested_at      AS requestedAt,
            B.due_at            AS dueAt,

            C.item_code         AS itemCode,
            C.item_name         AS itemName,
            C.spec              AS spec,

            D.id                AS materialId,
            D.material_code     AS materialCode,

            E.id                AS lineMaterialId,

            F.id                AS productionLineId,
            F.line_name         AS productionLineName,
            F.daily_capacity    AS dailyCapacity,
            D.base_unit              AS unit

        FROM production_request_item A
                 JOIN production_request B
                      ON B.id = A.pr_id

                 JOIN sales_order_item C
                      ON C.id = A.so_item_id

                 JOIN material D
                      ON D.material_code = C.item_code
                          AND D.type = 'MAT_FG'          -- 완제품만

                 JOIN line_material E
                      ON E.material_id = D.id

                 JOIN production_line F
                      ON F.id = E.line_id

        WHERE A.status = 'PIS_TARGET'
          AND NOT EXISTS (
            SELECT 1
            FROM production_plan G
            WHERE G.pr_item_id = A.id
              AND G.status = 'PP_CONFIRMED'   -- 확정만 제외
        )

        ORDER BY B.due_at ASC, A.id ASC;

    </select>

    <!-- ===================================================== -->
    <!-- 월별 생산계획 조회                                     -->
    <!-- ===================================================== -->
    <select id="selectMonthlyPlans"
            resultType="com.werp.sero.production.command.application.dto.PPMonthlyPlanResponseDTO">

        SELECT
            A.id                  AS ppId,
            A.pp_code             AS ppCode,
            A.production_line_id  AS productionLineId,

            C.id                  AS prId,
            C.pr_code             AS prCode,

            B.id                 AS prItemId,
            B.quantity           AS plannedQuantity,

            D.material_code        AS materialCode,
            D.name        AS materialName,
            D.base_unit AS unit,

            A.start_date          AS startDate,
            A.end_date            AS endDate,
            A.production_quantity AS productionQuantity,
            A.status              AS status

        FROM production_plan A
                 JOIN production_request_item B
                      ON A.pr_item_id = B.id
                 JOIN production_request C
                      ON B.pr_id = C.id
                 JOIN material D
                      ON D.material_code = (
                          SELECT E.item_code
                          FROM sales_order_item E
                          WHERE E.id = B.so_item_id
                      )
        WHERE
            A.start_date &lt;= #{monthEnd}
          AND A.end_date   &gt;= #{monthStart}
        ORDER BY
            A.production_line_id,
            A.start_date

    </select>

    <!-- ===================================================== -->
    <!-- 일자 기준 생산계획 + 작업지시 + 실적 미리보기                   -->
    <!-- ===================================================== -->

    <select id="selectDailyPreview"
            parameterType="string"
            resultType="com.werp.sero.production.query.dto.PPDailyPreviewResponseDTO">

        SELECT
            A.id                  AS ppId,
            A.pp_code             AS ppCode,

            F.id                  AS lineId,
            F.line_name           AS lineName,
            F.daily_capacity      AS dailyCapacity,

            E.id                  AS materialId,
            E.material_code       AS materialCode,
            E.name                AS materialName,
            E.base_unit           AS baseUnit,

            A.production_quantity AS plannedQuantity,

            /* 잔여 수량 (PP 기준) */
            (A.production_quantity - IFNULL(SUM(I.planned_quantity), 0)) AS remainingQuantity,

            /* 권장 수량 (오늘 기준) */
            CASE
            WHEN EXISTS (
            SELECT 1
            FROM work_order WO2
            WHERE WO2.line_id = F.id
            AND WO2.work_date = #{date}
            )
            THEN 0
            WHEN DATEDIFF(A.end_date, #{date}) + 1 &lt;= 0
            THEN 0
            ELSE CEILING(
            (A.production_quantity - IFNULL(SUM(I.planned_quantity), 0))
            / (DATEDIFF(A.end_date, #{date}) + 1)
            )
            END AS recommendedQuantity,

            /* 오늘 해당 라인에 작업지시 존재 여부 */
            (SELECT COUNT(*)
            FROM work_order WO
            WHERE WO.line_id = F.id
            AND WO.work_date = #{date}) > 0 AS hasWorkOrder

            FROM production_plan A
            JOIN production_request_item B
            ON A.pr_item_id = B.id
            JOIN sales_order_item D
            ON B.so_item_id = D.id
            JOIN material E
            ON E.material_code = D.item_code
            AND E.type = 'MAT_FG'
            JOIN production_line F
            ON A.production_line_id = F.id

            /* 이미 생성된 작업지시 */
            LEFT JOIN work_order G
            ON G.line_id = F.id
            AND G.work_date = #{date}

            /* 해당 작업지시에 포함된 PP 아이템 */
            LEFT JOIN work_order_item I
            ON I.work_order_id = G.id
            AND I.pp_id = A.id

            WHERE A.status = 'PP_CONFIRMED'
            AND A.start_date &lt;= #{date}
            AND A.end_date   &gt;= #{date}

            GROUP BY
            A.id, A.pp_code,
            F.id, F.line_name, F.daily_capacity,
            E.material_code, E.name, E.base_unit,
            A.production_quantity

        ORDER BY
            F.line_name ASC,
            A.pp_code ASC
    </select>

    <!-- ===================================================== -->
    <!-- 생산계획 상세 조회 (PP 단건)                          -->
    <!-- ===================================================== -->
    <select id="selectProductionPlanDetail"
            parameterType="int"
            resultType="com.werp.sero.production.query.dto.PPDetailResponseDTO">

        SELECT
            A.id                  AS ppId,
            A.pp_code             AS ppCode,
            A.status              AS status,
            A.start_date          AS startDate,
            A.end_date            AS endDate,
            A.production_quantity AS productionQuantity,

            C.id                  AS prId,
            C.pr_code             AS prCode,
            B.quantity   AS requestedQuantity,
            C.due_at               AS dueAt,

            B.id                  AS prItemId,
            D.item_code           AS itemCode,
            D.item_name           AS itemName,
            D.spec                AS spec,
            D.unit           AS unit,

            E.id                  AS productionLineId,
            E.line_name           AS productionLineName,
            E.daily_capacity      AS dailyCapacity

        FROM production_plan A
                 JOIN production_request_item B ON A.pr_item_id = B.id
                 JOIN production_request C ON B.pr_id = C.id
                 JOIN sales_order_item D ON B.so_item_id = D.id
                 JOIN production_line E ON A.production_line_id = E.id

        WHERE A.id = #{ppId}
    </select>


</mapper>