<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.werp.sero.shipping.query.dao.DOMapper">

    <!-- 납품서 상세 조회용 ResultMap -->
    <resultMap id="DODetailResultMap" type="com.werp.sero.shipping.query.dto.DODetailResponseDTO">
        <result property="doCode" column="do_code"/>
        <result property="doUrl" column="do_url"/>
        <result property="createdAt" column="created_at"/>
        <result property="recipient" column="recipient"/>
        <result property="companyName" column="company_name"/>
        <result property="ceoName" column="ceo_name"/>
        <result property="businessNo" column="business_no"/>
        <result property="companyContact" column="company_contact"/>
        <result property="address" column="address"/>
        <result property="businessType" column="business_type"/>
        <result property="businessItem" column="business_item"/>
        <result property="totalAmount" column="total_amount"/>
        <result property="shippedAt" column="shipped_at"/>
        <result property="deliveryLocation" column="delivery_location"/>
        <result property="note" column="note"/>

        <!-- 납품서 품목 목록 (Collection) -->
        <collection property="items" ofType="com.werp.sero.shipping.query.dto.DODetailResponseDTO$DODetailItemDTO">
            <result property="itemCode" column="item_code"/>
            <result property="itemName" column="item_name"/>
            <result property="spec" column="spec"/>
            <result property="quantity" column="quantity"/>
            <result property="unit" column="unit"/>
            <result property="unitPrice" column="unit_price"/>
            <result property="amount" column="amount"/>
        </collection>
    </resultMap>

    <!-- 납품서 상세 조회 -->
    <select id="findByDoCode" resultMap="DODetailResultMap">
        SELECT
            /* 납품서 기본 정보 */
            A.do_code,
            A.do_url,
            DATE_FORMAT(STR_TO_DATE(A.created_at, '%Y-%m-%d %H:%i:%s'), '%Y-%m-%d') AS created_at,
            A.shipped_at,
            A.note,

            /* 고객사 정보 */
            CONCAT(C.company_name, ' ', D.position, ' ', D.name) AS recipient,
            C.company_name,
            C.ceo_name,
            C.business_no,
            C.company_contact,
            B.address,
            C.business_type,
            C.business_item,

            /* 배송 정보 */
            B.address AS delivery_location,

            /* 품목 정보 (sales_order_item에서 직접 가져오기) */
            F.item_code,
            F.item_name,
            F.spec,
            E.do_quantity AS quantity,
            F.unit,
            F.unit_price,
            (E.do_quantity * F.unit_price) AS amount,

            /* 합계 금액 (서브쿼리) */
            (SELECT SUM(G.do_quantity * H.unit_price)
             FROM delivery_order_item G
             INNER JOIN sales_order_item H ON G.so_item_id = H.id
             WHERE G.do_id = A.id) AS total_amount

        FROM delivery_order A
        INNER JOIN sales_order B ON A.so_id = B.id
        INNER JOIN client C ON B.client_id = C.id
        LEFT JOIN client_employee D ON B.client_manager_id = D.id
        INNER JOIN delivery_order_item E ON A.id = E.do_id
        INNER JOIN sales_order_item F ON E.so_item_id = F.id

        WHERE A.do_code = #{doCode}
        ORDER BY E.id
    </select>

    <select id="selectDeliveryUrlsBySoId" resultType="string">
        SELECT
            A.do_url
        FROM delivery_order A
        WHERE so_id = #{orderId}
        ORDER BY created_at ASC
    </select>

    <!-- 상태별 및 담당자별 납품서 목록 조회 -->
    <select id="findByStatusAndManager" resultType="com.werp.sero.shipping.query.dto.DOListResponseDTO">
        SELECT
            /* 납품서 정보 */
            A.do_code AS doCode,
            A.created_at AS createdAt,
            A.shipped_at AS shippedAt,
            A.status AS status,

            /* 수주 정보 */
            B.so_code AS soCode,

            /* 고객사 정보 */
            C.company_name AS companyName,

            /* 담당자 정보 */
            D.name AS managerName,

            /* 품목 정보 (첫 번째 품목명) */
            (SELECT F.item_name
             FROM delivery_order_item E
             INNER JOIN sales_order_item F ON E.so_item_id = F.id
             WHERE E.do_id = A.id
             ORDER BY E.id
             LIMIT 1) AS itemName,

            /* 총 품목 개수 */
            (SELECT COUNT(*)
             FROM delivery_order_item E
             WHERE E.do_id = A.id) AS itemCount

        FROM delivery_order A
        INNER JOIN sales_order B ON A.so_id = B.id
        INNER JOIN client C ON B.client_id = C.id
        INNER JOIN employee D ON A.manager_id = D.id

        WHERE A.status = #{status}
          AND A.manager_id = #{managerId}
        ORDER BY A.created_at DESC
    </select>

    <!-- 주문 id별 납품서 목록 조회-->
    <select id="selectDOListByOrderId" resultType="com.werp.sero.shipping.query.dto.DOListResponseDTO">
        SELECT
            A.id AS doId,
            A.do_code AS doCode,
            B.so_code AS soCode,
            C.company_name AS companyName,
            D.name AS managerName,
            (SELECT F.item_name FROM delivery_order_item E
                                         INNER JOIN sales_order_item F ON E.so_item_id = F.id
             WHERE E.do_id = A.id ORDER BY E.id LIMIT 1) AS itemName,
        (SELECT COUNT(*) FROM delivery_order_item E WHERE E.do_id = A.id) AS itemCount,
        A.status AS status,
        DATE_FORMAT(A.created_at, '%Y-%m-%d') AS createdAt
        FROM delivery_order A
            INNER JOIN sales_order B ON A.so_id = B.id
            INNER JOIN client C ON B.client_id = C.id
            INNER JOIN employee D ON A.manager_id = D.id
        WHERE A.so_id = #{orderId}
        ORDER BY A.created_at DESC
    </select>

</mapper>
